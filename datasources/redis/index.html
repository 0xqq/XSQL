<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="../../img/favicon.ico">

    
    <title>Redis - XSQL</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">
    <link href="../../css/highlight.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="../..">XSQL</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../getting_started/Getting_Started/">Overview</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../tutorial/configuration/">Configuration</a>
</li>

                        
                            
<li >
    <a href="../../tutorial/syntax/">Special Syntax</a>
</li>

                        
                            
<li >
    <a href="../../tutorial/api/">API</a>
</li>

                        
                            
<li >
    <a href="../../tutorial/rest-api/">REST API</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Sources <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../hive/">Hive</a>
</li>

                        
                            
<li >
    <a href="../mysql/">MySQL</a>
</li>

                        
                            
<li >
    <a href="../elasticsearch/">Elasticsearch</a>
</li>

                        
                            
<li >
    <a href="../mongo/">MongoDB</a>
</li>

                        
                            
<li >
    <a href="../kafka/">Kafka</a>
</li>

                        
                            
<li >
    <a href="../hbase/">HBase</a>
</li>

                        
                            
<li class="active">
    <a href="./">Redis</a>
</li>

                        
                            
<li >
    <a href="../druid/">Druid</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Performance Report <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../performance_report/hive/">Hive</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/mysql/">MySQL</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/elasticsearch/">Elasticsearch</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/mongo/">MongoDB</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/hbase/">HBase</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/redis/">Redis</a>
</li>

                        
                            
<li >
    <a href="../../performance_report/multi_datasource/">Multiple Data Sources</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../jsoneditor/">Json Editor</a>
</li>

                        
                            
<li >
    <a href="../../functions/">Functions</a>
</li>

                        
                            
<li >
    <a href="../../troubleshooting/common/">Common Troubleshooting</a>
</li>

                        
                            
<li >
    <a href="../../troubleshooting/spark2.3-troubleshooting/">Spark2.3 Troubleshooting</a>
</li>

                        
                            
<li >
    <a href="../../troubleshooting/spark1.6-troubleshooting/">Spark1.6 Troubleshooting</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../hbase/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../druid/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#installation">Installation</a></li>
        <li class="first-level "><a href="#configuration">Configuration</a></li>
        <li class="first-level "><a href="#advanced-configuration">Advanced Configuration</a></li>
            <li class="second-level"><a href="#_1">元数据配置方法：</a></li>
                
            <li class="second-level"><a href="#1-schemas">1. 直接编辑schemas文件</a></li>
                
            <li class="second-level"><a href="#2">2. 自动推断未注册表的元数据（不推荐）</a></li>
                
        <li class="first-level "><a href="#execution">Execution</a></li>
            <li class="second-level"><a href="#select">可下推的select语句</a></li>
                
            <li class="second-level"><a href="#sparkvalue">使用Spark函数处理value</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<p>Redis是一个可基于内存亦可持久化的日志型、Key-Value数据库，提供高性能的数据缓存。</p>
<h2 id="installation">Installation</h2>
<p>由于Redis提供了Java API，所以不需要任何安装。对于想要了解Jedis的用户请查阅 <a href="http://www.javadoc.io/doc/redis.clients/jedis/2.9.0">Jedis官方文档</a> 。</p>
<h2 id="configuration">Configuration</h2>
<p>Redis接入XSQL的配置继承了<a href="http://10.161.184.19:51019/configurations/common/">Configurations</a>中针对特定数据源的type、url、version、pushdown、schemas配置。这里给出一个Redis接入XSQL的配置示例：</p>
<pre><code class="python">spark.xsql.datasources            redis_ds_name
spark.xsql.default.datasource     redis_ds_name
sprak.xsql.default.database       0
# 声明redis_ds_name是一个Redis数据源
spark.xsql.datasource.redis_ds_name.type     redis
# 配置jedis格式的url redis://:$password@$host:$port/[dbnum]
spark.xsql.datasource.redis_ds_name.url      redis://:xxx@xx.xx.xx.xx:xx
# 配置元数据存储文件名称，需要放置在SPARK_CONF_DIR中
spark.xsql.datasource.redis_ds_name.schemas  redis.schemas
# version为预留配置
spark.xsql.datasource.redis_ds_name.version  4.0.10
spark.xsql.datasource.redis_ds_name.pushdown true
</code></pre>

<h2 id="advanced-configuration">Advanced Configuration</h2>
<p>xsql为了访问Redis，用冒号分割每个键，得到键的前缀和后缀，将一个键值对视为表的一条记录，将键的前缀视为表名，表的列结构固定为<code>key</code>和<code>value</code>，key的字段类型固定为<code>string</code>，value的字段类型取决于值类型。</p>
<table>
<thead>
<tr>
<th align="left">Redis概念</th>
<th>对应的关系数据库概念</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">数据库（默认编号0-15）</td>
<td>数据库名</td>
</tr>
<tr>
<td align="left">键（keyprefix:keysuffix）</td>
<td>字段key</td>
</tr>
<tr>
<td align="left">值</td>
<td>字段value</td>
</tr>
<tr>
<td align="left">keyprefix</td>
<td>表名</td>
</tr>
<tr>
<td align="left">keysuffix</td>
<td>过滤字段suffix</td>
</tr>
<tr>
<td align="left">值类型（hash、list、set、zset、string）</td>
<td>字段value的字段类型（string、map、array）</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong></p>
<ul>
<li>list值类型和set值类型表示为spark的ArrayType(StringType)</li>
<li>zset值类型表示为MapType(StringType,DoubleType)</li>
<li>string值类型表示为StringType</li>
<li>hash值类型直接表示为记录，hash的每个键作为一个字段，对应的值作为字段值，这种情况下列结构不再固定为<code>key</code>和<code>value</code>。总结如下：</li>
</ul>
<table>
<thead>
<tr>
<th>值类型</th>
<th>xsql表示类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>StringType</td>
</tr>
<tr>
<td>list set</td>
<td>ArrayType(StringType)</td>
</tr>
<tr>
<td>zset</td>
<td>MapType(StringType,DoubleType)</td>
</tr>
<tr>
<td>hash</td>
<td>一系列类型可以不同的字段</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong></p>
<p>当相同前缀的键，值类型不统一时，不能使用xsql进行查询</p>
<p>当list、set、zset、hash出现复合对象时，即数组的数组时，不能使用xsql进行查询。</p>
<h3 id="_1">元数据配置方法：</h3>
<p>Redis自身没有任何元数据，用户在使用xsql查询Redis之前，需要显式给出数据表的元数据，具体包括：</p>
<h3 id="1-schemas">1. 直接编辑schemas文件</h3>
<p>redis.schemas存储的元数据是以数据库为索引的json对象，建议在编辑schemas文件时使用 <a href="../../jsoneditor/index.html?q=1">JSON编辑器</a> 避免低级错误。</p>
<p><strong>Examples</strong></p>
<pre><code class="json">{
    &quot;0&quot;:[
        {
            &quot;table&quot;:&quot;RedisSourceExampleTable&quot;,
            &quot;fields&quot;:[
                {
                    &quot;name&quot;:&quot;type&quot;，
                    &quot;type&quot;:&quot;string&quot;
                }
            ]
        },{
            &quot;table&quot;:&quot;hashTable&quot;,
            &quot;fields&quot;:[
                {
                    &quot;name&quot;:&quot;key&quot;,
                    &quot;type&quot;:&quot;string&quot;
                },{
                    &quot;name&quot;:&quot;name&quot;,
                    &quot;type&quot;:&quot;string&quot;
                },{
                    &quot;name&quot;:&quot;age&quot;,
                    &quot;type&quot;:&quot;int&quot;
                }
            ]
        },...
    ],
    &quot;1&quot;:[
        ...
    ]
}
</code></pre>

<p><strong>Note</strong></p>
<pre><code class="json">&quot;fields&quot;:[
    {
        &quot;name&quot;:&quot;type&quot;，
        &quot;type&quot;:&quot;string&quot;
    }
]
上面内容等价于下面内容，属于简写
&quot;fields&quot;:[
    {
        &quot;name&quot;:&quot;key&quot;，
        &quot;type&quot;:&quot;string&quot;
    },{
        &quot;name&quot;:&quot;value&quot;,
        &quot;type&quot;:&quot;string&quot;
    }
]
</code></pre>

<h3 id="2">2. 自动推断未注册表的元数据（不推荐）</h3>
<p>xsql可以通过全库扫描，找到一个以表名为前缀的键，获取该键的值类型，从而推测出一个未注册表的元数据。但自动推断方式缺点比较明显：</p>
<ul>
<li>全库扫描的速度缓慢</li>
<li>使用任意一个前缀满足要求的键去推测元数据类型，理论上是不可靠的</li>
</ul>
<p>因此xsql对redis开启自动推断机制，只是为了查询redis中的临时表，以及应对某些修改并重新加载schemas文件代价较大的情况。</p>
<h2 id="execution">Execution</h2>
<h3 id="select">可下推的select语句</h3>
<h4>点查询 <code>key =</code> <code>key in</code> <code>suffix =</code> <code>suffix in</code></h4>
<hr />
<p>获取特定键 对应的值</p>
<p><strong>Examples</strong></p>
<pre><code class="bash">&gt; use redis.`0`;
&gt; select * from `360:redis` where key = '360:redis:monitor';
key value
360:redis:monitor   1539853184
&gt; select * where key = '360:redis:monitor';
key value
360:redis:monitor   1539853364
&gt; select * where key in ('360:redis:monitor','360:redis:save')
key value
360:redis:monitor   1539854444
360:redis:save  idobi
&gt; select * from `360:redis` where suffix = 'monitor';
key value
360:redis:monitor   1539854624
&gt; select * from `360:redis` where suffix in ('monitor','save');
key value
360:redis:monitor   1539854684
360:redis:save  idobi
</code></pre>

<h4>限制value范围</h4>
<h4><code>range between and</code>（list、zset）</h4>
<hr />
<p>获取坐标介于特定区间的值</p>
<p><strong>Examples</strong></p>
<pre><code class="bash">&gt; select * from `redis-list`;
key value
redis-list:1    [&quot;1&quot;,&quot;123&quot;,&quot;231&quot;,&quot;231&quot;]
redis-list:2    [&quot;row3&quot;,&quot;row2&quot;,&quot;list1&quot;]
&gt; select * from `redis-list` where range between 0 and -1;
key value
redis-list:1    [&quot;1&quot;,&quot;123&quot;,&quot;231&quot;,&quot;231&quot;]
redis-list:2    [&quot;row3&quot;,&quot;row2&quot;,&quot;list1&quot;]
&gt; select * from `redis-list` where range between 1 and 2;
key value
redis-list:1    [&quot;123&quot;,&quot;231&quot;]
redis-list:2    [&quot;row2&quot;,&quot;list1&quot;]
</code></pre>

<h4><code>score between and</code>（zset）</h4>
<hr />
<p>获取score介于特定区间的值</p>
<p><strong>Examples</strong></p>
<pre><code class="bash">&gt; select * where key = 'redis-zset:2' and score between 20 and 1000;
key value
redis-zset:2    {&quot;12&quot;:700.0}
</code></pre>

<h3 id="sparkvalue">使用Spark函数处理value</h3>
<ul>
<li>对于值类型为list和set的表，建议使用<a href="../../functions/#sort_array">sort_array</a>、<a href="../../functions/#array_contains">array_contains</a>等函数</li>
<li>对于值类型为zset的表，建议使用<a href="../../functions/#map_values">map_values</a>等函数</li>
<li>对于值类型为string的表，建议使用<a href="../../functions/#regexp_extract">regexp_extract</a>等函数</li>
<li>对于值类型为json string的表，建议使用<a href="../../functions/#json_tuple">json_tuple</a>、<a href="../../functions/#get_json_object">get_json_object</a>、<a href="../../functions/#from_json">from_json</a>、<a href="../../functions/#to_json">to_json</a>等函数</li>
</ul>
<p>Spark提供的所有函数见 <a href="../../functions/">链接</a>。</p></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>

        
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
